sudo sed -i -e "s/ldpd=no/ldpd=yes/" /etc/frr/daemons
sudo systemctl restart frr

sudo modprobe mpls_router
sudo modprobe mpls_iptunnel
sudo modprobe mpls_gso
sudo modprobe dummy


cat << EOF | sudo tee /etc/sysctl.d/90-mpls-router.conf
net.ipv4.ip_forward=1
net.ipv6.conf.all.forwarding=1
net.ipv4.conf.all.rp_filter=0
net.mpls.platform_labels=1048575
net.ipv4.tcp_l3mdev_accept=1
net.ipv4.udp_l3mdev_accept=1
net.mpls.conf.lo.input=1
EOF
sudo sysctl -p /etc/sysctl.d/90-mpls-router.conf

router PE11
-----------

sudo ip link add dev dummy0 type dummy
sudo ip link set dev dummy0 up 
sudo ip addr add dev dummy0 192.168.255.11/32


sudo vtysh 
config t
interface dummy0
 ip router isis test1
 ipv6 router isis test1
 isis network point-to-point
exit
exit
write mem
end

router bgp 65001
 neighbor 192.168.255.12 remote-as 65001
 neighbor 192.168.255.12 update-source dummy0
 !
 address-family ipv4 vpn
  neighbor 192.168.255.12 activate
 exit-address-family
exit


sudo sysctl net.mpls.conf.eth1.input=1
sudo sysctl net.mpls.conf.eth2.input=1

config t
mpls ldp
 router-id 192.168.255.11
 address-family ipv4
  discovery transport-address 192.168.255.11
  interface eth1
  interface eth2
exit
exit
exit
write mem
end

sudo  ip link add customer1 type vrf table 100
sudo ip link set customer1 up
sudo ip route add vrf customer1 unreachable default metric 4278198272
sudo ip -6 route add vrf customer1 unreachable default metric 4278198272
sudo ip link set eth3.101 vrf customer1 


router bgp 65001 vrf customer1
 address-family ipv4 unicast
  redistribute connected
  label vpn export auto
  rd vpn export 65000:100
  rt vpn both 65000:100
  export vpn
  import vpn


router PE12
-----------

sudo ip link add dev dummy0 type dummy
sudo ip link set dev dummy0 up 
sudo ip addr add dev dummy0 192.168.255.12/32



mpls ldp
 router-id 192.168.255.12
 address-family ipv4
  discovery transport-address 192.168.255.12
  interface eth1
  interface eth2
exit
exit
exit
write mem
end


router bgp 65001
 neighbor 192.168.255.11 remote-as 65001
 neighbor 192.168.255.11 update-source dummy0
 !
 address-family ipv4 vpn
  neighbor 192.168.255.11 activate
 exit-address-family
exit


router P1
-----------

sudo ip link add dev dummy0 type dummy
sudo ip link set dev dummy0 up 
sudo ip addr add dev dummy0 192.168.255.1/32

mpls ldp
 router-id 192.168.255.1
 address-family ipv4
  discovery transport-address 192.168.255.1
  interface eth1
  interface eth2



router P2
-----------

sudo ip link add dev dummy0 type dummy
sudo ip link set dev dummy0 up 
sudo ip addr add dev dummy0 192.168.255.2/32


mpls ldp
 router-id 192.168.255.2
 address-family ipv4
  discovery transport-address 192.168.255.2
  interface eth1
  interface eth2
exit
exit
exit
interface dummy0 
mpls enable
exit



